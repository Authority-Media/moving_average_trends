from flask import Flask, request, jsonify
import json
import logging
import os
from slack_sdk import WebClient
import urllib.parse
from main import fetch_moving_averages, analyze_videos


app = Flask(__name__)

# Set up logging
logging.basicConfig(level=logging.INFO)

SLACK_BOT_TOKEN = os.getenv('SLACK_BOT_TOKEN')

slack_client = WebClient(token=SLACK_BOT_TOKEN)

@app.route('/slack/interactivity-endpoint', methods=['POST'])
def interactivity_endpoint():
    # Slack sends interaction data as a JSON string in the 'payload' form field
    interaction_data = json.loads(request.form.get('payload', '{}'))
    
    # Log the interaction data
    logging.info(f"Received interaction: {interaction_data}")

    # Acknowledge the interaction with an empty JSON body
    return jsonify({})


@app.route('/error-logging', methods=['POST'])
def error_logging():
    error_data = request.json  # Assuming error details are sent as a JSON payload
    logging.error(f"Error logged: {error_data}")
    # Here, you could add the error to a monitoring system or a database
    return jsonify({'status': 'Error Received'})

@app.route('/alert-sent', methods=['POST'])
def alert_sent():
    # This is a simple logging endpoint for when main.py sends an alert
    data = request.json  # Assuming main.py sends a JSON payload
    logging.info(f"Alert sent: {data}")
    return jsonify({'status': 'Received'})




@app.route('/slack/actions', methods=['POST'])
def slack_actions():
    encoded_payload = request.get_data(as_text=True)
    decoded_payload = urllib.parse.unquote(encoded_payload)
    payload_str = decoded_payload.split("payload=")[1]
    payload_dict = json.loads(payload_str)
    trigger_id = payload_dict['trigger_id']
    actions = payload_dict['actions']
    video_id = actions[0]['value']  # Retrieve the video_id from the button's value

    # Optional: Retrieve the video URL from the database if additional metadata is needed
    # video_url = get_video_url(video_id)

    try:
        # Construct the view with the video block
        view = {
            "type": "modal",
            "title": {
                "type": "plain_text",
                "text": "Video Details"
            },
            "blocks": [
                {
                    "type": "video",
                    "video_url": f"https://www.youtube.com/embed/{video_id}?feature=oembed&autoplay=1",
                    "alt_text": "Embedded Video"
                }
                # ... additional blocks as needed ...
            ]
        }

        response = slack_client.views_open(trigger_id=trigger_id, view=view)

        if not response["ok"]:
            raise ValueError(f"Failed to open modal: {response['error']}")

        return "", 200 
    except Exception as e:
        print(e)
        return "Internal Server Error", 500


@app.route('/slack/notifications', methods=['GET'])
def send_notifications():
    df_moving_averages = fetch_moving_averages()
    if df_moving_averages is not None and not df_moving_averages.empty:
        analyze_videos(df_moving_averages)
        return jsonify({'status': 'Notification sent'})

    else:
        return jsonify({'status': 'No moving averages found to analyze'})


if __name__ == '__main__':
    app.run(debug=True, port=8080)


